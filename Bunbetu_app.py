import streamlit as st
from PIL import Image
import torch

# --- ãƒ©ãƒ™ãƒ« â†’ ã‚«ãƒ†ã‚´ãƒªå¤‰æ› ---
label_to_category = {import streamlit as st
from PIL import Image
import torch

# ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œè¡¨
label_to_category = {
    "bottle": "è³‡æºã‚´ãƒŸï¼ˆãƒšãƒƒãƒˆãƒœãƒˆãƒ«ï¼‰ğŸ§´",
    "can": "è³‡æºã‚´ãƒŸï¼ˆç¼¶ï¼‰ğŸ¥«",
    "cup": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç´™ã‚³ãƒƒãƒ—ï¼‰â˜•",
    "banana": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŒ",
    "apple": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸ",
    "orange": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŠ",
    "broccoli": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥¦",
    "carrot": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥•",
    "pizza": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ•",
    "cake": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ°",
    "laptop": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­æ©Ÿå™¨ï¼‰ğŸ’»",
    "cell phone": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼ï¼‰ğŸ“±",
    "tv": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ†ãƒ¬ãƒ“ï¼‰ğŸ“º",
    "microwave": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­ãƒ¬ãƒ³ã‚¸ï¼‰ğŸ”¥",
    "vase": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé™¶å™¨ï¼‰ğŸº",
    "book": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ“š",
    "newspaper": "è³‡æºã‚´ãƒŸï¼ˆæ–°èç´™ï¼‰ğŸ—ï¸",
    "toilet paper": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ§»",
    "dining table": "ç²—å¤§ã”ã¿ï¼ˆå®¶å…·ï¼‰ğŸ›‹ï¸",
    "chair": "ç²—å¤§ã”ã¿ï¼ˆæ¤…å­ï¼‰ğŸª‘",
    "bed": "ç²—å¤§ã”ã¿ï¼ˆãƒ™ãƒƒãƒ‰ï¼‰ğŸ›ï¸",
    "person": "åˆ†åˆ¥ä¸å¯ï¼ˆäººé–“ï¼‰ğŸš«",
    "handbag": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé©ãƒ»å¸ƒï¼‰ğŸ‘œ",
    "shoe": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé´ï¼‰ğŸ‘",
    "backpack": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆå¸ƒé¡ï¼‰ğŸ’",
    "clock": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆæ©Ÿæ¢°ï¼‰â°",
    "umbrella": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆå‚˜ï¼‰ğŸŒ‚",
    "scissors": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé‡‘å±ï¼‰âœ‚ï¸",
    "toothbrush": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ï¼‰ğŸª¥"
}

@st.cache_resource
def load_model():
    return torch.hub.load('ultralytics/yolov5', 'yolov5n', source='github')

model = load_model()

st.set_page_config(page_title="ã‚´ãƒŸåˆ†åˆ¥AI", page_icon="â™»ï¸")
st.title("â™»ï¸ ã‚´ãƒŸåˆ†åˆ¥AIã‚¢ãƒ—ãƒª")
st.write("ğŸ–¼ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ã‚´ãƒŸã®ç¨®é¡ã‚’è‡ªå‹•åˆ¤åˆ¥ã—ã¾ã™ã€‚")

img_data = st.file_uploader("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type=["jpg", "jpeg", "png"])

if img_data:
    try:
        img = Image.open(img_data)
        st.image(img, caption="ğŸ“· å…¥åŠ›ç”»åƒ", use_container_width=True)

        with st.spinner("AIãŒã”ã¿ã‚’åˆ¤åˆ¥ä¸­..."):
            results = model(img)
            df = results.pandas().xyxy[0]

        if df.empty:
            st.warning("âš ï¸ ã‚´ãƒŸãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã§ãŠè©¦ã—ãã ã•ã„ã€‚")
        else:
            st.subheader("ğŸ§  åˆ†åˆ¥çµæœ")
            for _, row in df.iterrows():
                label = row["name"]
                conf = row["confidence"]
                category = label_to_category.get(label, "âš ï¸ æœªåˆ†é¡ï¼ˆæ‰‹å‹•ç¢ºèªï¼‰")
                st.write(f"- **{label}**ï¼ˆä¿¡é ¼åº¦: {conf:.2f}ï¼‰ â†’ {category}")
    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")

    "bottle": "è³‡æºã‚´ãƒŸï¼ˆãƒšãƒƒãƒˆãƒœãƒˆãƒ«ï¼‰ğŸ§´",
    "can": "è³‡æºã‚´ãƒŸï¼ˆç¼¶ï¼‰ğŸ¥«",
    "cup": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç´™ã‚³ãƒƒãƒ—ï¼‰â˜•",
    "banana": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŒ",
    "apple": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸ",
    "orange": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆç”Ÿã‚´ãƒŸï¼‰ğŸŠ",
    "broccoli": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥¦",
    "carrot": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé‡èœï¼‰ğŸ¥•",
    "pizza": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ•",
    "cake": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé£Ÿã¹æ®‹ã—ï¼‰ğŸ°",
    "laptop": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­æ©Ÿå™¨ï¼‰ğŸ’»",
    "cell phone": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼ï¼‰ğŸ“±",
    "tv": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ†ãƒ¬ãƒ“ï¼‰ğŸ“º",
    "microwave": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé›»å­ãƒ¬ãƒ³ã‚¸ï¼‰ğŸ”¥",
    "vase": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé™¶å™¨ï¼‰ğŸº",
    "book": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ“š",
    "newspaper": "è³‡æºã‚´ãƒŸï¼ˆæ–°èç´™ï¼‰ğŸ—ï¸",
    "toilet paper": "è³‡æºã‚´ãƒŸï¼ˆç´™é¡ï¼‰ğŸ§»",
    "dining table": "ç²—å¤§ã”ã¿ï¼ˆå®¶å…·ï¼‰ğŸ›‹ï¸",
    "chair": "ç²—å¤§ã”ã¿ï¼ˆæ¤…å­ï¼‰ğŸª‘",
    "bed": "ç²—å¤§ã”ã¿ï¼ˆãƒ™ãƒƒãƒ‰ï¼‰ğŸ›ï¸",
    "person": "åˆ†åˆ¥ä¸å¯ï¼ˆäººé–“ï¼‰ğŸš«",
    "handbag": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé©ãƒ»å¸ƒï¼‰ğŸ‘œ",
    "shoe": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆé´ï¼‰ğŸ‘",
    "backpack": "ç‡ƒãˆã‚‹ã‚´ãƒŸï¼ˆå¸ƒé¡ï¼‰ğŸ’",
    "clock": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆæ©Ÿæ¢°ï¼‰â°",
    "umbrella": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆå‚˜ï¼‰ğŸŒ‚",
    "scissors": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆé‡‘å±ï¼‰âœ‚ï¸",
    "toothbrush": "ç‡ƒãˆãªã„ã‚´ãƒŸï¼ˆãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ï¼‰ğŸª¥"
}

# --- ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ ---
@st.cache_resource
def load_model():
    return torch.hub.load('ultralytics/yolov5', 'yolov5n', source='github')

model = load_model()

# --- UIæ§‹ç¯‰ ---
st.set_page_config(page_title="ã‚´ãƒŸåˆ†åˆ¥AI", page_icon="â™»ï¸")
st.title("â™»ï¸ ã‚´ãƒŸåˆ†åˆ¥AIã‚¢ãƒ—ãƒª")
st.write("ğŸ“· ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ ğŸ–¼ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã§AIãŒã”ã¿ã‚’è‡ªå‹•åˆ¤åˆ¥ã—ã¾ã™ã€‚")

# --- å…¥åŠ›æ–¹å¼é¸æŠ ---
method = st.radio("ç”»åƒã®å…¥åŠ›æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„", ["ğŸ–¼ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", "ğŸ“· ã‚«ãƒ¡ãƒ©æ’®å½±"])

img_data = None
if method == "ğŸ–¼ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰":
    img_data = st.file_uploader("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["jpg", "jpeg", "png"])
else:
    img_data = st.camera_input("ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã—ã¦ãã ã•ã„")

# --- æ¨è«–å‡¦ç† ---
if img_data:
    try:
        image = Image.open(img_data)
        st.image(image, caption="ğŸ“¸ å…¥åŠ›ç”»åƒ", use_container_width=True)

        with st.spinner("AIãŒã”ã¿ã‚’è­˜åˆ¥ä¸­..."):
            results = model(image)
            df = results.pandas().xyxy[0]

        if df.empty:
            st.warning("âš ï¸ ã‚´ãƒŸãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚")
        else:
            st.subheader("ğŸ§  åˆ†åˆ¥çµæœ")
            for _, row in df.iterrows():
                label = row["name"]
                conf = row["confidence"]
                category = label_to_category.get(label, "âš ï¸ æœªåˆ†é¡ï¼ˆæ‰‹å‹•ç¢ºèªï¼‰")
                st.write(f"- **{label}**ï¼ˆä¿¡é ¼åº¦: {conf:.2f}ï¼‰ â†’ {category}")

    except Exception as e:
        st.error(f"ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
